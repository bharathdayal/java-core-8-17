<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>JVM Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>JVM Metrics Dashboard</h1>

<!-- Memory Chart -->
<canvas id="memoryChart" width="600" height="300"></canvas>
<hr>

<!-- Threads Chart -->
<canvas id="threadsChart" width="600" height="300"></canvas>
<hr>

<!-- GC Pause Chart -->
<canvas id="gcChart" width="600" height="300"></canvas>
<hr>

<!-- Classes Chart -->
<canvas id="classesChart" width="600" height="300"></canvas>
<hr>

<!-- CPU Usage Chart -->
<canvas id="cpuChart" width="600" height="300"></canvas>
<hr>

<!-- Files Chart -->
<canvas id="filesChart" width="600" height="300"></canvas>
<hr>

<!-- Uptime Chart -->
<canvas id="uptimeChart" width="600" height="300"></canvas>
<hr>

<!-- New Object Details Chart -->
<canvas id="objectDetailsChart" width="600" height="300"></canvas>

<script th:inline="javascript">
    /*<![CDATA[*/
    const memoryUsedStr = /*[[${memoryUsed}]]*/ '{}';
    const memoryMaxStr = /*[[${memoryMax}]]*/ '{}';
    const threadsStr = /*[[${threadsLive}]]*/ '{}';
    const gcStr = /*[[${gcPause}]]*/ '{}';
    const classesLoadedStr = /*[[${classesLoaded}]]*/ '{}';
    const classesUnloadedStr = /*[[${classesUnloaded}]]*/ '{}';
    const processCpuStr = /*[[${processCpu}]]*/ '{}';
    const systemCpuStr = /*[[${systemCpu}]]*/ '{}';
    const filesOpenStr = /*[[${filesOpen}]]*/ '{}';
    const uptimeStr = /*[[${uptime}]]*/ '{}';

    const memoryUsedJson = JSON.parse(memoryUsedStr);
    const memoryMaxJson = JSON.parse(memoryMaxStr);
    const threadsJson = JSON.parse(threadsStr);
    const gcJson = JSON.parse(gcStr);
    const classesLoadedJson = JSON.parse(classesLoadedStr);
    const classesUnloadedJson = JSON.parse(classesUnloadedStr);
    const processCpuJson = JSON.parse(processCpuStr);
    const systemCpuJson = JSON.parse(systemCpuStr);
    const filesOpenJson = JSON.parse(filesOpenStr);
    const uptimeJson = JSON.parse(uptimeStr);

    function getValue(json) {
        return json && json.measurements ? (json.measurements.find(m => m.statistic === "VALUE") || {}).value || 0 : 0;
    }

    // Memory
    const usedMemory = getValue(memoryUsedJson);
    const maxMemory = getValue(memoryMaxJson);
    if (usedMemory && maxMemory) {
        new Chart(document.getElementById('memoryChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Used', 'Free'],
                datasets: [{
                    data: [usedMemory, maxMemory - usedMemory],
                    backgroundColor: ['rgba(255,99,132,0.6)', 'rgba(54,162,235,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'JVM Heap Memory Usage' } }
            }
        });
    }

    // Threads
    const threadCount = getValue(threadsJson);
    if (threadCount) {
        new Chart(document.getElementById('threadsChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Live Threads'],
                datasets: [{
                    label: 'Count',
                    data: [threadCount],
                    backgroundColor: ['rgba(255,206,86,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'Live Threads' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // GC Pause
    const gcValues = gcJson && gcJson.measurements ? gcJson.measurements.map(m => m.value) : [];
    if (gcValues.length > 0) {
        new Chart(document.getElementById('gcChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: gcValues.map((_, i) => 'Pause ' + (i + 1)),
                datasets: [{
                    label: 'GC Pause Duration (seconds)',
                    data: gcValues,
                    backgroundColor: 'rgba(75,192,192,0.4)',
                    borderColor: 'rgba(75,192,192,1)',
                    fill: true
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'GC Pause Durations' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Classes
    const loadedClasses = getValue(classesLoadedJson);
    const unloadedClasses = getValue(classesUnloadedJson);
    if (loadedClasses || unloadedClasses) {
        new Chart(document.getElementById('classesChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Loaded', 'Unloaded'],
                datasets: [{
                    label: 'Classes',
                    data: [loadedClasses, unloadedClasses],
                    backgroundColor: ['rgba(54,162,235,0.6)', 'rgba(255,99,132,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'Classes Loaded vs Unloaded' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // CPU
    const processCpu = getValue(processCpuJson);
    const systemCpu = getValue(systemCpuJson);
    if (processCpu || systemCpu) {
        new Chart(document.getElementById('cpuChart').getContext('2d'), {
            type: 'radar',
            data: {
                labels: ['Process CPU Usage', 'System CPU Usage'],
                datasets: [{
                    label: 'CPU',
                    data: [processCpu, systemCpu],
                    backgroundColor: 'rgba(153,102,255,0.4)',
                    borderColor: 'rgba(153,102,255,1)',
                    fill: true
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'CPU Usage' } },
                scales: { r: { min: 0, max: 1 } }
            }
        });
    }

    // Files
    if (filesOpenJson && filesOpenJson.measurements) {
        const openFiles = getValue(filesOpenJson);
        new Chart(document.getElementById('filesChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Open Files'],
                datasets: [{
                    label: 'Count',
                    data: [openFiles],
                    backgroundColor: ['rgba(255,206,86,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'Open File Descriptors' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Uptime
    const uptime = getValue(uptimeJson);
    if (uptime) {
        new Chart(document.getElementById('uptimeChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Uptime (seconds)'],
                datasets: [{
                    data: [uptime],
                    backgroundColor: ['rgba(75,192,192,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'Process Uptime' } }
            }
        });
    }

    // New Object Details Chart
    if (loadedClasses || usedMemory || threadCount) {
        new Chart(document.getElementById('objectDetailsChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Approx Objects (Loaded Classes)', 'Heap Used (MB)', 'Live Threads'],
                datasets: [{
                    label: 'Approximate Object Details',
                    data: [loadedClasses, (usedMemory / (1024 * 1024)).toFixed(2), threadCount],
                    backgroundColor: ['rgba(54,162,235,0.6)', 'rgba(255,159,64,0.6)', 'rgba(75,192,192,0.6)']
                }]
            },
            options: {
                plugins: { title: { display: true, text: 'Approximate JVM Object Details' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
    /*]]>*/
</script>
</body>
</html>
